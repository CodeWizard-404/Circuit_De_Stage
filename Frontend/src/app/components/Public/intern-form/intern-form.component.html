<mat-stepper [linear]="isLinear" #stepper>
    <!-- Personal Info Step -->
    <mat-step [stepControl]="personalInfo">
        <form [formGroup]="personalInfo">
            <ng-template matStepLabel>Personal Information</ng-template>

            <mat-checkbox formControlName="isGroup">Group Application (Bin√¥me)</mat-checkbox>

            <div class="form-section">
                <h3>Primary Applicant</h3>
                <mat-form-field appearance="outline">
                    <mat-label>First Name</mat-label>
                    <input matInput formControlName="prenom" required>
                    <mat-error *ngIf="personalInfo.get('prenom')?.hasError('required')">
                        First Name is required
                    </mat-error>
                </mat-form-field>

                <mat-form-field appearance="outline">
                    <mat-label>Last Name</mat-label>
                    <input matInput formControlName="nom" required>
                    <mat-error *ngIf="personalInfo.get('nom')?.hasError('required')">
                        Last Name is required
                    </mat-error>
                </mat-form-field>

                <mat-form-field appearance="outline">
                    <mat-label>CIN</mat-label>
                    <input matInput formControlName="cin" required>
                    <mat-error *ngIf="personalInfo.get('cin')?.hasError('required')">
                        CIN is required
                    </mat-error>
                    <mat-error *ngIf="personalInfo.get('cin')?.hasError('pattern')">
                        CIN must be 8 digits
                    </mat-error>
                </mat-form-field>

                <mat-form-field appearance="outline">
                    <mat-label>Personal Email</mat-label>
                    <input matInput formControlName="emailPerso" required>
                    <mat-error *ngIf="personalInfo.get('emailPerso')?.hasError('required')">
                        Email is required
                    </mat-error>
                    <mat-error *ngIf="personalInfo.get('emailPerso')?.hasError('email')">
                        Invalid email format
                    </mat-error>
                </mat-form-field>

                <mat-form-field appearance="outline">
                    <mat-label>Phone Number</mat-label>
                    <input matInput formControlName="tel" required>
                    <mat-error *ngIf="personalInfo.get('tel')?.hasError('required')">
                        Phone Number is required
                    </mat-error>
                    <mat-error *ngIf="personalInfo.get('tel')?.hasError('pattern')">
                        Phone Number must be 8 digits
                    </mat-error>
                </mat-form-field>

                <mat-form-field appearance="outline">
                    <mat-label>Institute</mat-label>
                    <input matInput formControlName="institut" required>
                    <mat-error *ngIf="personalInfo.get('institut')?.hasError('required')">
                        Institute is required
                    </mat-error>
                </mat-form-field>

                <mat-form-field appearance="outline">
                    <mat-label>Level</mat-label>
                    <input matInput formControlName="niveau" required>
                    <mat-error *ngIf="personalInfo.get('niveau')?.hasError('required')">
                        Level is required
                    </mat-error>
                </mat-form-field>

                <mat-form-field appearance="outline">
                    <mat-label>Year</mat-label>
                    <input matInput formControlName="annee" required>
                    <mat-error *ngIf="personalInfo.get('annee')?.hasError('required')">
                        Year is required
                    </mat-error>
                </mat-form-field>

                <mat-form-field appearance="outline">
                    <mat-label>Specialty</mat-label>
                    <input matInput formControlName="specialite" required>
                    <mat-error *ngIf="personalInfo.get('specialite')?.hasError('required')">
                        Specialty is required
                    </mat-error>
                </mat-form-field>
            </div>

            <div *ngIf="personalInfo.get('isGroup')?.value" class="form-section">
                <h3>Group Member</h3>
                <mat-form-field appearance="outline">
                    <mat-label>First Name</mat-label>
                    <input matInput formControlName="prenom2">
                </mat-form-field>

                <mat-form-field appearance="outline">
                    <mat-label>Last Name</mat-label>
                    <input matInput formControlName="nom2">
                </mat-form-field>

                <mat-form-field appearance="outline">
                    <mat-label>CIN</mat-label>
                    <input matInput formControlName="cin2">
                </mat-form-field>

                <mat-form-field appearance="outline">
                    <mat-label>Personal Email</mat-label>
                    <input matInput formControlName="emailPerso2">
                    <mat-error *ngIf="personalInfo.get('emailPerso2')?.hasError('email')">
                        Invalid email format
                    </mat-error>
                </mat-form-field>

                <mat-form-field appearance="outline">
                    <mat-label>Phone Number</mat-label>
                    <input matInput formControlName="tel2">
                </mat-form-field>

                <mat-form-field appearance="outline">
                    <mat-label>Specialty</mat-label>
                    <input matInput formControlName="specialite2">
                </mat-form-field>
            </div>

            <div class="stepper-actions">
                <button mat-button matStepperNext [disabled]="personalInfo.invalid">Next</button>
            </div>
        </form>
    </mat-step>

    <!-- Internship Details Step -->
    <mat-step [stepControl]="internshipInfo">
        <form [formGroup]="internshipInfo">
            <ng-template matStepLabel>Internship Details</ng-template>

            <mat-form-field appearance="outline">
                <mat-label>Internship Type</mat-label>
                <mat-select formControlName="stageType" (selectionChange)="getRequiredDocuments()" required>
                    <mat-option *ngFor="let type of stageTypes" [value]="type">
                        {{ type }}
                    </mat-option>
                </mat-select>
                <mat-error *ngIf="internshipInfo.get('stageType')?.hasError('required')">
                    Internship Type is required
                </mat-error>
            </mat-form-field>

            <mat-form-field appearance="outline">
                <mat-label>Start Date</mat-label>
                <input matInput [matDatepicker]="startDatePicker" formControlName="dateDebut" required>
                <mat-datepicker-toggle matSuffix [for]="startDatePicker"></mat-datepicker-toggle>
                <mat-datepicker #startDatePicker></mat-datepicker>
                <mat-error *ngIf="internshipInfo.get('dateDebut')?.hasError('required')">
                    Start Date is required
                </mat-error>
            </mat-form-field>

            <mat-form-field appearance="outline">
                <mat-label>End Date</mat-label>
                <input matInput [matDatepicker]="endDatePicker" formControlName="dateFin" required>
                <mat-datepicker-toggle matSuffix [for]="endDatePicker"></mat-datepicker-toggle>
                <mat-datepicker #endDatePicker></mat-datepicker>
                <mat-error *ngIf="internshipInfo.get('dateFin')?.hasError('required')">
                    End Date is required
                </mat-error>
            </mat-form-field>

            <div class="stepper-actions">
                <button mat-button matStepperPrevious>Back</button>
                <button mat-button matStepperNext [disabled]="internshipInfo.invalid">Next</button>
            </div>
        </form>
    </mat-step>

    <!-- Documents Step -->
    <mat-step>
        <ng-template matStepLabel>Documents Upload</ng-template>

        <div class="documents-section">
            <div *ngFor="let docType of requiredDocuments" class="document-upload">
                <h4>{{ docType }} Document</h4>
                <input type="file" (change)="onFileSelected($event, docType)" [accept]="'application/pdf'">
                <mat-error *ngIf="documentsMap.get(docType) === undefined">
                    {{ docType }} is required
                </mat-error>
            </div>
        </div>

        <div class="stepper-actions">
            <button mat-button matStepperPrevious>Back</button>
            <button mat-raised-button color="primary" (click)="onSubmit()"
                [disabled]="documentsMap.size < requiredDocuments.length">
                Submit Application
            </button>
        </div>
    </mat-step>
</mat-stepper>